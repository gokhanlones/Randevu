<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personel - Stilix</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#f5f5f5;}

.navbar{
  height:60px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  display:flex;align-items:center;
  padding:0 20px;color:#fff;font-weight:600;
}

.main{padding:20px;display:flex;justify-content:center;}
.container{width:100%;max-width:900px;}

.card{
  background:#fff;
  border-radius:20px;
  padding:22px;
  box-shadow:0 8px 25px rgba(0,0,0,0.06);
}

.card h3{margin-bottom:16px;}

.input-group{margin-bottom:12px;}
.input-group label{display:block;font-size:0.9rem;margin-bottom:5px;}
.input-group input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:2px solid #ddd;
  outline:none;
}
.input-group input:focus{border-color:#667eea;}

.services-list{
  max-height:220px;
  overflow-y:auto;
  border:1px solid #eee;
  padding:12px;
  border-radius:12px;
  margin-bottom:18px;
}

.service-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 6px;
  border-bottom:1px solid #f1f1f1;
  font-size:0.92rem;
}
.service-item:last-child{border-bottom:none;}
.service-item input{transform:scale(1.05);}

.days{
  display:flex;
  gap:8px;
  margin-bottom:18px;
  flex-wrap:nowrap;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  justify-content:flex-start;
  padding-bottom:2px;
  scrollbar-width:none;
}
.days::-webkit-scrollbar{display:none;}

.day-btn{
  width:34px;
  height:34px;
  flex:0 0 34px;
  border-radius:9999px;
  aspect-ratio:1 / 1;
  border:2px solid #ddd;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:0.85rem;
  font-weight:800;
  background:#fff;
  transition:0.2s;
  user-select:none;
}
.day-btn.active{
  background:#667eea;
  color:#fff;
  border-color:#667eea;
}

.time-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.time-grid label{display:block;font-size:0.85rem;margin-bottom:6px;}
.time-grid input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:2px solid #ddd;
}

.save-btn{
  margin-top:18px;
  width:100%;
  padding:16px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#4caf50,#66bb6a);
  color:#fff;
  font-weight:700;
  font-size:1rem;
  cursor:pointer;
}

.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  background:#111;
  color:#fff;
  padding:10px 14px;
  border-radius:12px;
  display:none;
  z-index:9999;
  font-size:0.9rem;
}
</style>
</head>

<body>

<div class="navbar">
  <i class="fas fa-arrow-left" onclick="goBack()" style="margin-right:15px;cursor:pointer;"></i>
  Personel Yönetimi
</div>

<div class="main">
  <div class="container">
    <div class="card">
      <h3>Personel Ekle</h3>

      <div class="input-group">
        <label>Adı</label>
        <input type="text" id="ad">
      </div>

      <div class="input-group">
        <label>Soyadı</label>
        <input type="text" id="soyad">
      </div>

      <h4 style="margin:18px 0 10px 0;">Hizmetler</h4>
      <div class="services-list" id="servicesContainer">Yükleniyor...</div>

      <h4 style="margin:18px 0 10px 0;">Çalışma Günleri</h4>
      <div class="days" id="daysRow">
        <div class="day-btn" data-day="Pzt">P</div>
        <div class="day-btn" data-day="Sal">S</div>
        <div class="day-btn" data-day="Çar">Ç</div>
        <div class="day-btn" data-day="Per">P</div>
        <div class="day-btn" data-day="Cum">C</div>
        <div class="day-btn" data-day="Cmt">C</div>
        <div class="day-btn" data-day="Paz">P</div>
      </div>

      <h4 style="margin:18px 0 10px 0;">Çalışma Saatleri</h4>
      <div class="time-grid">
        <div>
          <label>Başlangıç</label>
          <input type="time" id="baslangic">
        </div>
        <div>
          <label>Bitiş</label>
          <input type="time" id="bitis">
        </div>
        <div>
          <label>Öğle Başlangıç</label>
          <input type="time" id="ogleBaslangic">
        </div>
        <div>
          <label>Öğle Bitiş</label>
          <input type="time" id="ogleBitis">
        </div>
      </div>

      <button class="save-btn">Kaydet</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ✅ DÜZELTILDI: Boşluk kaldırıldı, tek API
const API = "https://script.google.com/macros/s/AKfycbyyyOXkHUJzeiChozbKksBFoxeyZ0fj6A-Nc7a6fZz3hnFZw8vLq9-FyarjbxEeK4A/exec";

function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.display="block";
  setTimeout(()=>t.style.display="none",2200);
}

function goBack(){
  window.location.href = "branch-edit.html";
}

function jsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Date.now();
    
    window[cb] = (d) => {
      try { delete window[cb]; } catch(e){}
      if (s.parentNode) s.parentNode.removeChild(s);
      resolve(d);
    };

    const q = new URLSearchParams({ action, callback: cb, ...params }).toString();
    const s = document.createElement("script");
    s.src = API + "?" + q;
    
    s.onerror = () => {
      try { delete window[cb]; } catch(e){}
      reject(new Error("API hatası"));
    };
    
    document.body.appendChild(s);
  });
}

function getToken(){return localStorage.getItem("stilix_token");}
function getSubeId(){return localStorage.getItem("selectedBranch");}

async function loadSubeServices() {
  const subeId = getSubeId();
  const token = getToken();
  const container = document.getElementById("servicesContainer");

  if (!subeId || !token) {
    container.innerHTML = "Şube/Token bulunamadı";
    return;
  }

  container.innerHTML = "Yükleniyor...";

  try {
    // 1) Master listeyi al
    const masterRes = await jsonp("getMasterServices", {});
    console.log("Master:", masterRes); // Debug
    
    const master = masterRes.services || [];
    if (!master.length) {
      container.innerHTML = "Master hizmet listesi boş";
      return;
    }

    const masterMap = {};
    master.forEach(s => {
      const id = String(s.hizmetId || "").trim();
      const ad = String(s.hizmet || "").trim();
      if (id && ad) masterMap[id] = ad;
    });

    // 2) Şube hizmetlerini al
    const subeRes = await jsonp("getSubeServices", { token, subeId });
    console.log("Sube:", subeRes); // Debug
    
    const subeServices = subeRes.services || [];

    // Şube hizmeti yoksa master'dan göster (veya boş mesaj)
    if (!subeServices.length) {
      // İstersen burada master'dan göster, şimdilik boş diyelim
      container.innerHTML = "Bu şubede aktif hizmet yok. Önce İşletme Ayarları'ndan hizmet ekleyin.";
      return;
    }

    // 3) Render et
    container.innerHTML = "";
    let shown = 0;
    
    subeServices.forEach(s => {
      const id = String(s.hizmetId || "").trim();
      const ad = masterMap[id];
      
      if (!id || !ad) {
        console.log("Eşleşmeyen:", id, ad); // Debug
        return;
      }

      const div = document.createElement("div");
      div.className = "service-item";
      div.innerHTML = `<input type="checkbox" value="${id}" id="svc_${id}"><label for="svc_${id}" style="cursor:pointer;">${ad}</label>`;
      container.appendChild(div);
      shown++;
    });

    if (shown === 0) {
      container.innerHTML = "Eşleşen hizmet bulunamadı";
    }

  } catch (err) {
    console.error("Hata:", err);
    container.innerHTML = "Hizmet yüklenemedi: " + err.message;
    toast("Hizmet yüklenemedi");
  }
}

async function savePersonel() {
  const token = localStorage.getItem("stilix_token");
  const subeId = localStorage.getItem("selectedBranch");

  if (!token || !subeId) {
    toast("Yetkisiz erişim");
    return;
  }

  const ad = document.getElementById("ad").value.trim();
  const soyad = document.getElementById("soyad").value.trim();

  if (!ad || !soyad) {
    toast("Ad ve Soyad zorunlu");
    return;
  }

  // 1️⃣ PERSONEL EKLE
  const personelRes = await jsonp("addPersonel", {
    token,
    subeId,
    ad,
    soyad
  });

  if (!personelRes.success) {
    toast(personelRes.message || "Personel kaydedilemedi");
    return;
  }

  const personelId = personelRes.personelId;

  // 2️⃣ MESAI TOPLA
  const mesai = [];
  const baslangic = document.getElementById("baslangic").value;
  const bitis = document.getElementById("bitis").value;
  const ogleBaslangic = document.getElementById("ogleBaslangic").value;
  const ogleBitis = document.getElementById("ogleBitis").value;

  // Gün haritalaması (data-day attribute'larına göre)
  const gunMap = {
    "Pzt": "Pazartesi",
    "Sal": "Salı",
    "Çar": "Çarşamba",
    "Per": "Perşembe",
    "Cum": "Cuma",
    "Cmt": "Cumartesi",
    "Paz": "Pazar"
  };

  document.querySelectorAll(".day-btn.active").forEach(btn => {
    const gunKisa = btn.dataset.day; // Pzt, Sal, Çar, vb.
    const gunTam = gunMap[gunKisa];
    
    if (gunTam) {
      mesai.push({
        gun: gunTam,
        baslangic,
        bitis,
        ogleBaslangic,
        ogleBitis
      });
    }
  });

  if (mesai.length > 0) {
    await jsonp("savePersonelMesai", {
      token,
      personelId,
      subeId,
      mesai: JSON.stringify(mesai)
    });
  }

  // 3️⃣ HIZMETLER
  const hizmetler = [];
  document.querySelectorAll("#servicesContainer input:checked")
    .forEach(cb => hizmetler.push(cb.value));

  if (hizmetler.length > 0) {
    await jsonp("savePersonelHizmetler", {
      token,
      personelId,
      subeId,
      hizmetler: JSON.stringify(hizmetler)
    });
  }

  toast("Personel başarıyla kaydedildi");
  
  // Form temizleme (opsiyonel)
  setTimeout(() => {
    document.getElementById("ad").value = "";
    document.getElementById("soyad").value = "";
    document.querySelectorAll(".day-btn.active").forEach(btn => btn.classList.remove("active"));
    document.querySelectorAll("#servicesContainer input:checked").forEach(cb => cb.checked = false);
    document.getElementById("baslangic").value = "";
    document.getElementById("bitis").value = "";
    document.getElementById("ogleBaslangic").value = "";
    document.getElementById("ogleBitis").value = "";
  }, 1000);
}

document.addEventListener("DOMContentLoaded", () => {
  if(!getToken() || !getSubeId()){
    window.location.href = "business-login.html";
    return;
  }
  
  loadSubeServices();

  document.querySelectorAll(".day-btn").forEach(btn => {
    btn.addEventListener("click", () => btn.classList.toggle("active"));
  });

  // Save buton event listener
  document.querySelector(".save-btn").addEventListener("click", savePersonel);
});
</script>

</body>
</html>
