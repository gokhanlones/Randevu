<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>İşletme Ayarları - Stilix</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#f5f5f5;}

.navbar{
height:60px;
background:linear-gradient(135deg,#667eea,#764ba2);
display:flex;align-items:center;
padding:0 20px;color:#fff;gap:15px;
}
.navbar i{cursor:pointer}

.main{padding:25px;display:flex;justify-content:center;}
.container{width:100%;max-width:950px;}

.accordion-card{
background:#fff;
border-radius:20px;
margin-bottom:20px;
overflow:hidden;
box-shadow:0 8px 25px rgba(0,0,0,0.06);
}

.accordion-header{
padding:20px;
font-weight:600;
display:flex;
justify-content:space-between;
align-items:center;
cursor:pointer;
background:#f9f9f9;
}

.accordion-header i{
transition:0.3s;
}

.accordion-header.active i{
transform:rotate(180deg);
}

.accordion-content{
max-height:0;
overflow:hidden;
transition:0.4s;
padding:0 20px;
}

.accordion-content.active{
max-height:3000px;
padding:20px;
}

.grid2{
display:grid;
grid-template-columns:1fr 1fr;
gap:12px;
}
@media (max-width:820px){
.grid2{grid-template-columns:1fr;}
}

.input-group{margin-bottom:12px;}
.input-group label{display:block;font-size:0.9rem;margin-bottom:4px;color:#333;}

.input-group input,
.input-group select{
width:100%;
padding:10px;
border-radius:10px;
border:2px solid #ddd;
outline:none;
}
.input-group input:focus,
.input-group select:focus{border-color:#667eea;}

.service-card{
padding:15px 0;
border-bottom:1px solid #eee;
}
.service-title{
font-weight:600;
margin-bottom:8px;
}
.service-inputs{
display:flex;
gap:10px;
}
.service-inputs input{
flex:1;
padding:10px;
border-radius:10px;
border:2px solid #ddd;
}

.save-btn{
width:100%;
padding:18px;
border:none;
border-radius:14px;
background:linear-gradient(135deg,#4caf50,#66bb6a);
color:#fff;
font-weight:700;
font-size:1rem;
cursor:pointer;
}

.toast{
position:fixed;
left:50%;
bottom:22px;
transform:translateX(-50%);
background:#111;
color:#fff;
padding:10px 14px;
border-radius:12px;
display:none;
}
</style>
</head>

<body>

<div class="navbar">
<i class="fas fa-arrow-left" onclick="goBack()"></i>
İşletme Ayarları
</div>

<div class="main">
<div class="container">

<!-- BUSINESS -->
<div class="accordion-card">
<div class="accordion-header" onclick="toggleSection('businessSection')">
<span>İşletme Bilgileri</span>
<i class="fas fa-chevron-down"></i>
</div>
<div class="accordion-content" id="businessSection">

<div class="input-group">
<label>Şube Adı</label>
<input type="text" id="sube_adi">
</div>

<div class="grid2">

<div class="input-group">
<label>Ülke</label>
<select id="ulke">
<option value="Türkiye">Türkiye</option>
</select>
</div>

<div class="input-group">
<label>İl</label>
<select id="il"></select>
</div>

<div class="input-group">
<label>İlçe</label>
<select id="ilce"></select>
</div>

<div class="input-group">
<label>Mahalle</label>
<select id="mahalle"></select>
</div>

<div class="input-group">
<label>Cadde</label>
<input type="text" id="cadde">
</div>

<div class="input-group">
<label>Sokak</label>
<input type="text" id="sokak">
</div>

<div class="input-group">
<label>Bina No</label>
<input type="text" id="bina_no">
</div>

<div class="input-group">
<label>Bina Adı</label>
<input type="text" id="bina_adi">
</div>

<div class="input-group">
<label>Kat</label>
<input type="text" id="kat">
</div>

<div class="input-group">
<label>Daire</label>
<input type="text" id="daire">
</div>

</div>
</div>
</div>

<!-- SERVICES -->
<div class="accordion-card">
<div class="accordion-header" onclick="toggleSection('servicesSection')">
<span>Hizmetler</span>
<i class="fas fa-chevron-down"></i>
</div>
<div class="accordion-content" id="servicesSection">
<div id="service-container">Yükleniyor...</div>
</div>
</div>

<button class="save-btn" onclick="saveAll()">Kaydet</button>

</div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxubPVNJG1qKvQPcz5qR3mBvwX5zXfKWHCjuuqJLqC0iCK3l_wNU1yD94-_D8_wyaGc/exec";

// Accordion
function toggleSection(id){
const contents=document.querySelectorAll(".accordion-content");
const headers=document.querySelectorAll(".accordion-header");
const target=document.getElementById(id);
const header=target.previousElementSibling;
const open=target.classList.contains("active");

contents.forEach(c=>c.classList.remove("active"));
headers.forEach(h=>h.classList.remove("active"));

if(!open){
target.classList.add("active");
header.classList.add("active");
}
}

function goBack(){window.location.href="branch-edit.html";}

function toast(msg){
const t=document.getElementById("toast");
t.textContent=msg;
t.style.display="block";
setTimeout(()=>t.style.display="none",1500);
}

function jsonp(action,params={}){
return new Promise(resolve=>{
const cb="cb_"+Date.now();
window[cb]=d=>{delete window[cb];document.body.removeChild(s);resolve(d);};
const q=new URLSearchParams({action,callback:cb,...params}).toString();
const s=document.createElement("script");
s.src=API+"?"+q;
document.body.appendChild(s);
});
}

function getToken(){return localStorage.getItem("stilix_token");}
function getSubeId(){return localStorage.getItem("selectedBranch");}

// ADDRESS LOAD
async function loadIller(selectedIl){
const res=await jsonp("getIller");
const ilSelect=document.getElementById("il");
ilSelect.innerHTML="<option value=''>Seçiniz</option>";
res.iller.forEach(il=>{
const o=document.createElement("option");
o.value=il;o.textContent=il;
if(il===selectedIl)o.selected=true;
ilSelect.appendChild(o);
});
}

async function loadIlceler(il,selectedIlce){
const res=await jsonp("getIlceler",{il});
const s=document.getElementById("ilce");
s.innerHTML="<option value=''>Seçiniz</option>";
res.ilceler.forEach(x=>{
const o=document.createElement("option");
o.value=x;o.textContent=x;
if(x===selectedIlce)o.selected=true;
s.appendChild(o);
});
}

async function loadMahalleler(il,ilce,selectedMah){
const res=await jsonp("getMahalleler",{il,ilce});
const s=document.getElementById("mahalle");
s.innerHTML="<option value=''>Seçiniz</option>";
res.mahalleler.forEach(x=>{
const o=document.createElement("option");
o.value=x;o.textContent=x;
if(x===selectedMah)o.selected=true;
s.appendChild(o);
});
}

// BRANCH LOAD
async function loadBranchInfo(){
const res=await jsonp("getBranch",{token:getToken(),subeId:getSubeId()});
if(!res.success)return;
const b=res.branch;

document.getElementById("sube_adi").value=b.sube_adi||"";
document.getElementById("ulke").value=b.ulke||"Türkiye";

await loadIller(b.il);
if(b.il) await loadIlceler(b.il,b.ilce);
if(b.il&&b.ilce) await loadMahalleler(b.il,b.ilce,b.mahalle);

document.getElementById("cadde").value=b.cadde||"";
document.getElementById("sokak").value=b.sokak||"";
document.getElementById("bina_no").value=b.bina_no||"";
document.getElementById("bina_adi").value=b.bina_adi||"";
document.getElementById("kat").value=b.kat||"";
document.getElementById("daire").value=b.daire||"";
}

// SERVICES LOAD
async function loadServices(){
const container=document.getElementById("service-container");
container.innerHTML="Yükleniyor...";

const res=await jsonp("getMasterServices");
if(!res.success){
container.innerHTML="Hizmet yüklenemedi";
return;
}

container.innerHTML="";
res.services.forEach(s=>{
const div=document.createElement("div");
div.className="service-card";
div.innerHTML=`
<div class="service-title">${s.hizmet}</div>
<div class="service-inputs">
<input type="number" placeholder="Süre (dk)" data-id="${s.hizmetId}" class="sure">
<input type="number" placeholder="Fiyat (₺)" data-id="${s.hizmetId}" class="fiyat">
</div>
`;
container.appendChild(div);
});
}

// SAVE ALL
async function saveAll(){
const branchPayload={
token:getToken(),
subeId:getSubeId(),
subeAdi:sube_adi.value,
ulke:ulke.value,
il:il.value,
ilce:ilce.value,
mahalle:mahalle.value,
cadde:cadde.value,
sokak:sokak.value,
binaNo:bina_no.value,
binaAdi:bina_adi.value,
kat:kat.value,
daire:daire.value
};

await jsonp("updateBranch",branchPayload);

// SERVICES
const services=[];
document.querySelectorAll(".sure").forEach(input=>{
const id=input.dataset.id;
const sure=input.value;
const fiyat=document.querySelector(`.fiyat[data-id="${id}"]`).value;
if(sure || fiyat){
services.push({hizmetId:id,sure,fiyat});
}
});

await jsonp("updateBranchServices",{token:getToken(),subeId:getSubeId(),services:JSON.stringify(services)});

toast("Kaydedildi");
}

document.addEventListener("DOMContentLoaded",async()=>{
await loadBranchInfo();
await loadServices();
});
</script>

</body>
</html>
