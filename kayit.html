<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kayıt Ol</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
:root {
    --primary: #4F46E5;
    --primary-hover: #4338CA;
    --light-bg: #F3F4F6;
    --card-bg: #FFFFFF;
    --text-dark: #1F2937;
    --border: #E5E7EB;
    --success: #10B981;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
    font-family:'Segoe UI', sans-serif;
    background:var(--light-bg);
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
}

.container {
    width:100%;
    max-width:420px;
    padding:20px;
}

.card {
    background:var(--card-bg);
    padding:40px 35px;
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.08);
}

.card h2 {
    text-align:center;
    margin-bottom:10px;
    color:var(--text-dark);
}

.subtitle {
    text-align:center;
    color:#6B7280;
    font-size:14px;
    margin-bottom:25px;
}

.input-group {
    margin-bottom:16px;
}

.input-group label {
    display:block;
    margin-bottom:6px;
    font-size:13px;
    color:var(--text-dark);
    font-weight:500;
}

.input-group input {
    width:100%;
    padding:13px;
    border-radius:8px;
    border:1px solid var(--border);
    font-size:14px;
}

.input-group input:focus {
    outline:none;
    border-color:var(--primary);
    box-shadow:0 0 0 2px rgba(79,70,229,0.15);
}

.code-input {
    text-align:center !important;
    letter-spacing:8px !important;
    font-size:24px !important;
    font-weight:bold !important;
}

.save-btn {
    width:100%;
    padding:13px;
    border:none;
    border-radius:8px;
    background:var(--primary);
    color:white;
    font-size:15px;
    font-weight:500;
    cursor:pointer;
    transition:0.2s ease;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:8px;
}

.save-btn:hover {
    background:var(--primary-hover);
}

.save-btn:disabled {
    opacity:0.7;
    cursor:not-allowed;
}

.back {
    text-align:center;
    margin-top:20px;
    font-size:14px;
}

.back a {
    color:var(--primary);
    text-decoration:none;
    cursor:pointer;
}

#result {
    margin-top:15px;
    padding:12px;
    border-radius:8px;
    text-align:center;
    display:none;
    font-size:14px;
}

.success {
    background:#d1fae5;
    color:#065f46;
    border:1px solid #a7f3d0;
}

.error {
    background:#fee2e2;
    color:#991b1b;
    border:1px solid #fecaca;
}

.hidden {
    display:none !important;
}

.step {
    display:none;
}

.step.active {
    display:block;
}

.resend {
    text-align:center;
    margin-top:15px;
    font-size:13px;
    color:#6B7280;
}

.resend a {
    color:var(--primary);
    cursor:pointer;
    text-decoration:underline;
}
</style>
</head>

<body>

<div class="container">
<div class="card">

    <!-- ADIM 1: Kayıt Formu -->
    <div id="step1" class="step active">
        <h2>Kayıt Ol</h2>
        <p class="subtitle">Hesabınızı oluşturmaya başlayın</p>

        <form id="registerForm" onsubmit="return handleRegister();">
            <div class="input-group">
                <input type="text" id="firstName" placeholder="Ad" required>
            </div>

            <div class="input-group">
                <input type="text" id="lastName" placeholder="Soyad" required>
            </div>

            <div class="input-group">
                <input type="email" id="email" placeholder="Email" required>
            </div>

            <div class="input-group">
                <input type="email" id="email2" placeholder="Email Tekrar" required>
            </div>

            <div class="input-group">
                <input type="tel" id="phone" placeholder="Telefon (05xxxxxxxxx)" required>
            </div>

            <button type="submit" class="save-btn" id="registerBtn">
                <i class="fa-solid fa-user-plus"></i> Kaydet
            </button>
        </form>
    </div>

    <!-- ADIM 2: Kod Doğrulama -->
    <div id="step2" class="step">
        <h2>Kodu Doğrula</h2>
        <p class="subtitle"><span id="emailDisplay"></span> adresine gönderilen 6 haneli kodu girin</p>

        <form id="verifyForm" onsubmit="return handleVerify();">
            <div class="input-group">
                <input type="text" id="verificationCode" class="code-input" placeholder="------" maxlength="6" required autocomplete="off">
            </div>

            <button type="submit" class="save-btn" id="verifyBtn">
                <i class="fa-solid fa-check"></i> Doğrula
            </button>
        </form>

        <div class="resend">
            Kod gelmedi mi? <a onclick="resendCode()">Tekrar gönder</a>
        </div>

        <div class="back">
            <a onclick="goBack()">← Geri dön</a>
        </div>
    </div>

    <!-- ADIM 3: Şifre Oluştur -->
    <div id="step3" class="step">
        <h2>Şifre Oluştur</h2>
        <p class="subtitle">Hesabınızı güvence altına alın</p>

        <form id="passwordForm" onsubmit="return handlePassword();">
            <div class="input-group">
                <input type="password" id="password" placeholder="Şifre (en az 6 karakter)" required minlength="6">
            </div>

            <div class="input-group">
                <input type="password" id="password2" placeholder="Şifre Tekrar" required>
            </div>

            <button type="submit" class="save-btn" id="passwordBtn">
                <i class="fa-solid fa-lock"></i> Hesabı Oluştur
            </button>
        </form>

        <div class="back">
            <a onclick="goBackToCode()">← Geri dön</a>
        </div>
    </div>

    <!-- ADIM 4: Başarılı -->
    <div id="step4" class="step">
        <div style="text-align:center;padding:20px 0;">
            <i class="fa-solid fa-circle-check" style="font-size:64px;color:var(--success);margin-bottom:20px;"></i>
            <h2>Hesabınız Oluşturuldu!</h2>
            <p class="subtitle">Giriş yapabilirsiniz</p>
            <a href="giris.html" class="save-btn" style="text-decoration:none;margin-top:20px;">
                <i class="fa-solid fa-right-to-bracket"></i> Giriş Yap
            </a>
        </div>
    </div>

    <div id="result"></div>

    <div class="back" id="mainBack">
        <a href="index.html">Ana sayfaya dön</a>
    </div>

</div>
</div>

<script>
// Geçici veri saklama
let tempUserData = {};
let generatedCode = null;

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwfv9mGLOV5cpizTukvM1t26U1xJ--Z6MWjRlB6KQLg4almvGW_cKy8JjVhnXQQLmT0PQ/exec';

function showStep(stepNumber) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + stepNumber).classList.add('active');
    
    if (stepNumber === 2 || stepNumber === 3) {
        document.getElementById('mainBack').style.display = 'none';
    } else {
        document.getElementById('mainBack').style.display = 'block';
    }
}

function showResult(msg, type) {
    const div = document.getElementById('result');
    div.textContent = msg;
    div.className = type;
    div.style.display = 'block';
    setTimeout(() => div.style.display = 'none', 5000);
}

// ADIM 1: Kayıt
function handleRegister() {
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const email = document.getElementById('email').value.trim();
    const email2 = document.getElementById('email2').value.trim();
    const phone = document.getElementById('phone').value.trim();

    if (email !== email2) {
        showResult('Email adresleri eşleşmiyor!', 'error');
        return false;
    }

    if (!/^05\d{9}$/.test(phone.replace(/\s/g,''))) {
        showResult('Telefon 05xxxxxxxxx formatında olmalı!', 'error');
        return false;
    }

    // 6 haneli kod oluştur
    generatedCode = Math.floor(100000 + Math.random() * 900000).toString();
    
    // Veriyi sakla
    tempUserData = { firstName, lastName, email, phone };

    // Buton loading
    const btn = document.getElementById("registerBtn");
    btn.disabled = true;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Gönderiliyor...`;

    // ✅ TÜM verileri gönder (telefon dahil)
    const formData = new FormData();
    formData.append('action', 'sendVerificationCode');
    formData.append('email', email);
    formData.append('code', generatedCode);
    formData.append('firstName', firstName);
    formData.append('lastName', lastName);
    formData.append('phone', phone); // ✅ TELEFON EKLENDİ

    fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
    }).catch(() => {});

    // 2 saniye bekle ve adım 2'ye geç
    setTimeout(() => {
        document.getElementById('emailDisplay').textContent = email;
        showStep(2);
        document.getElementById('verificationCode').focus();
        
        btn.disabled = false;
        btn.innerHTML = `<i class="fa-solid fa-user-plus"></i> Kaydet`;
    }, 2000);

    return false;
}

// ADIM 2: Kod Doğrula
function handleVerify() {
    const enteredCode = document.getElementById('verificationCode').value.trim();
    
    if (enteredCode !== generatedCode) {
        showResult('Kod hatalı! Lütfen tekrar deneyin.', 'error');
        return false;
    }

    showStep(3);
    return false;
}

// ADIM 3: Şifre Oluştur
function handlePassword() {
    const password = document.getElementById('password').value;
    const password2 = document.getElementById('password2').value;

    if (password !== password2) {
        showResult('Şifreler eşleşmiyor!', 'error');
        return false;
    }

    if (password.length < 6) {
        showResult('Şifre en az 6 karakter olmalı!', 'error');
        return false;
    }

    // Buton loading
    const btn = document.getElementById("passwordBtn");
    btn.disabled = true;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Oluşturuluyor...`;

    // ✅ TÜM verileri gönder (email dahil!)
    const formData = new FormData();
    formData.append('action', 'completeRegisterWithCode');
    formData.append('email', tempUserData.email); // ✅ EMAIL EKLENDİ
    formData.append('password', password);
    formData.append('firstName', tempUserData.firstName);
    formData.append('lastName', tempUserData.lastName);
    formData.append('phone', tempUserData.phone);

    fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
    }).catch(() => {});

    // 2 saniye bekle ve başarılı sayfasına geç
    setTimeout(() => {
        showStep(4);
    }, 2000);

    return false;
}

function resendCode() {
    generatedCode = Math.floor(100000 + Math.random() * 900000).toString();
    
    const formData = new FormData();
    formData.append('action', 'sendVerificationCode');
    formData.append('email', tempUserData.email);
    formData.append('code', generatedCode);
    formData.append('firstName', tempUserData.firstName);
    formData.append('lastName', tempUserData.lastName);
    formData.append('phone', tempUserData.phone);

    fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
    }).catch(() => {});

    showResult('Yeni kod gönderildi!', 'success');
}

function goBack() {
    showStep(1);
    document.getElementById('mainBack').style.display = 'block';
}

function goBackToCode() {
    showStep(2);
}
</script>

</body>
</html>
