<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Email Doğrulama</title>

<style>
body {
    margin:0;
    font-family:'Segoe UI', sans-serif;
    background:#F3F4F6;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
}
.card {
    background:white;
    padding:40px;
    border-radius:14px;
    width:100%;
    max-width:400px;
    text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,0.08);
}
input {
    width:100%;
    padding:12px;
    margin-top:15px;
    border-radius:8px;
    border:1px solid #ddd;
}
button {
    width:100%;
    padding:12px;
    margin-top:15px;
    border:none;
    border-radius:8px;
    background:#4F46E5;
    color:white;
    cursor:pointer;
}
.hidden {
    display:none;
}
</style>
</head>

<body>

<div class="card">
    <h2 id="title">Email Doğrulanıyor...</h2>
    <div id="message">Lütfen bekleyin...</div>

    <div id="passwordArea" class="hidden">
        <input type="password" id="pass1" placeholder="Şifre">
        <input type="password" id="pass2" placeholder="Şifre Tekrar">
        <button onclick="completeRegister()">Kaydı Tamamla</button>
    </div>
</div>

<script>

let currentToken = null;

async function verify() {

    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");
    currentToken = token;

    if (!token) {
        document.getElementById("message").innerText = "Geçersiz link.";
        return;
    }

    try {

        const response = await fetch("https://script.google.com/macros/s/AKfycbwi95rXGOA8VkTgYoZU1VoUS3KK5nqQ6ysPOdTxUFRmov13e13dUg3WUbE5yw9yJ2jDxg/exec", {
            method: "POST",
            body: JSON.stringify({
                action: "verifyToken",
                token: token
            })
        });

        const result = await response.json();

        if (result.success) {

            document.getElementById("title").innerText = "Email Doğrulandı";
            document.getElementById("message").innerText = "Lütfen şifrenizi oluşturun.";
            document.getElementById("passwordArea").classList.remove("hidden");

        } else {
            document.getElementById("message").innerText = result.message;
        }

    } catch (err) {
        document.getElementById("message").innerText = "Sunucu hatası.";
    }
}

async function completeRegister(){

    const p1 = document.getElementById("pass1").value;
    const p2 = document.getElementById("pass2").value;

    if(!p1 || !p2){
        alert("Tüm alanları doldurun");
        return;
    }

    if(p1 !== p2){
        alert("Şifreler eşleşmiyor");
        return;
    }

    if(p1.length < 6){
        alert("Şifre en az 6 karakter olmalı");
        return;
    }

    const response = await fetch("https://script.google.com/macros/s/AKfycbzDxnb-3boRNy0D937jhItJC8_6z5QbP0VOhJfUfPKLiU3aPkXtyPobCjhNXsC7AfR7Mg/exec", {
        method:"POST",
        body:JSON.stringify({
            action:"completeRegister",
            token:currentToken,
            password:p1
        })
    });

    const result = await response.json();

    if(result.success){
        alert("Hesap oluşturuldu");
        window.location.href="giris.html";
    } else {
        alert(result.message);
    }
}

verify();

</script>

</body>
</html>
